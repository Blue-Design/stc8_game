#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "sys.h"
#include "delay.h"
#include "timer.h"
#include "led8.h"
#include "matrix.h"
#include "nixietube.h"
#include "hc595.h"
#include "keyboard.h"
#include "lcd1602.h"
#include "oled.h"
#include "dht11.h"
#include "tftlcd.h"
#include "gui.h"
#include "touch.h"
#include "ir.h"
#include "pcf8563.h"

uint8 B_100us = 0;
uint16 tim0_ms = 50;

// 2048游戏数据
uint16 data2048[4][4];
int score, best;

// "2048" 字模(32x32)
uint8 str_2048[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xF8,0x00,0x00,0x1C,0x3C,0x00,
    0x00,0x38,0x1E,0x00,0x00,0x3C,0x1E,0x00,0x00,0x3C,0x1E,0x00,0x00,0x3C,0x1E,0x00,
    0x00,0x00,0x1E,0x00,0x00,0x00,0x1C,0x00,0x00,0x00,0x3C,0x00,0x00,0x00,0x38,0x00,
    0x00,0x00,0x70,0x00,0x00,0x00,0xE0,0x00,0x00,0x01,0xC0,0x00,0x00,0x03,0x80,0x00,
    0x00,0x07,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x0C,0x06,0x00,0x00,0x18,0x0C,0x00,
    0x00,0x30,0x0C,0x00,0x00,0x3F,0xFC,0x00,0x00,0x3F,0xFC,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*２*/
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xF0,0x00,0x00,0x0E,0x38,0x00,
    0x00,0x1C,0x38,0x00,0x00,0x1C,0x1C,0x00,0x00,0x1C,0x1C,0x00,0x00,0x38,0x1C,0x00,
    0x00,0x38,0x1C,0x00,0x00,0x38,0x1C,0x00,0x00,0x38,0x1C,0x00,0x00,0x38,0x1C,0x00,
    0x00,0x38,0x1C,0x00,0x00,0x38,0x1C,0x00,0x00,0x38,0x1C,0x00,0x00,0x38,0x1C,0x00,
    0x00,0x38,0x1C,0x00,0x00,0x38,0x1C,0x00,0x00,0x1C,0x1C,0x00,0x00,0x1C,0x18,0x00,
    0x00,0x1C,0x38,0x00,0x00,0x0E,0x70,0x00,0x00,0x07,0xE0,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*０*/
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x70,0x00,
    0x00,0x00,0x70,0x00,0x00,0x00,0xF0,0x00,0x00,0x01,0xF0,0x00,0x00,0x03,0xF0,0x00,
    0x00,0x03,0x70,0x00,0x00,0x06,0x70,0x00,0x00,0x0E,0x70,0x00,0x00,0x0C,0x70,0x00,
    0x00,0x18,0x70,0x00,0x00,0x38,0x70,0x00,0x00,0x70,0x70,0x00,0x00,0x60,0x70,0x00,
    0x00,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x70,0x00,0x00,0x00,0x70,0x00,
    0x00,0x00,0x70,0x00,0x00,0x00,0xF8,0x00,0x00,0x03,0xFF,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*４*/
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xF0,0x00,0x00,0x0E,0x1C,0x00,
    0x00,0x1C,0x0C,0x00,0x00,0x1C,0x0C,0x00,0x00,0x3C,0x0E,0x00,0x00,0x3C,0x0C,0x00,
    0x00,0x1C,0x1C,0x00,0x00,0x1E,0x38,0x00,0x00,0x0F,0xF0,0x00,0x00,0x03,0xE0,0x00,
    0x00,0x07,0xF8,0x00,0x00,0x0E,0x7C,0x00,0x00,0x18,0x3E,0x00,0x00,0x38,0x1E,0x00,
    0x00,0x30,0x0E,0x00,0x00,0x30,0x0E,0x00,0x00,0x30,0x0E,0x00,0x00,0x38,0x0E,0x00,
    0x00,0x1C,0x1C,0x00,0x00,0x0F,0x78,0x00,0x00,0x01,0xC0,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*８*/
};

// 设置测试数据
void setdata(){
    uint8 i, j;
    for(i=0; i<4; ++i){
        for(j=0; j<4; ++j){
            data2048[i][j] = 16 << i << j;
        }
    }
    score = best = 0;
}

// 字符：0   1   2   3   4   5   6   7   8   9   #   *   w(+) s(/) a(-) d(x) ok
// IR  ：13  0   1   2   4   5   6   8   9   10  14  12  17   25   20   22   21
// 按键：0   1   2   3   4   5   6   7   8   9   35  42  43   47   45   120  -
void main(void){
    uint8 buf[50], slen;
    uint8 i, j;
    pcf8563_Time localtime;
    
	InitMCU();
    Timer0_init();
    Timer4_init();
    EA = 1;		// 中断总开关
    
    pcf8563_init();
    ir_rx_init();
    tft_lcd_init();
    tft_lcd_clear(TFT_LCD_LGRAY);
    
    pcf8563_read_rtc(&localtime);
    srand(((long *)&localtime)[0]+((long *)&localtime)[1]);
    
    // 游戏界面初始化
    setdata();
    tft_lcd_show_font32(4,str_2048,56,8,TFT_LCD_BRED,TFT_LCD_WHITE,1);
    tft_lcd_show_string(36,300,"Join the tiles, get to 2048!",TFT_LCD_GRAY,TFT_LCD_WHITE,12,1);
    tft_lcd_draw_rectangle(19, 91, 221, 293, TFT_LCD_BLACK);
    tft_lcd_fill_rectangle(20, 92, 220, 292, TFT_LCD_LGRAYBLUE);
    tft_lcd_draw_rectangle(150, 55, 220, 79, TFT_LCD_BLACK);
    tft_lcd_fill_rectangle(151, 56, 219, 78, TFT_LCD_LBBLUE);
    tft_lcd_show_string(161,61,"New Game",TFT_LCD_WHITE,TFT_LCD_WHITE,12,1);
    for(i=0; i<5; ++i){
        tft_lcd_draw_line(20, 92+50*i, 220, 92+50*i, TFT_LCD_GRAYBLUE);
        tft_lcd_draw_line(20+50*i, 92, 20+50*i, 292, TFT_LCD_GRAYBLUE);
    }
    
    while(1){
        if(IO_KeyState){
            // 红外发送
            ir_send_nec(1, KEY_MAP[KeyCode]);
            while(IO_KeyState);
        }
        if(B_100us){
            B_100us = 0;
            if(ir_rx_available()){
                // 红外接收
//                switch(ir_rx_ircode()){
//                    case 21:
//                        tft_lcd_show_string(50,50,"yes!!!",TFT_LCD_RED,TFT_LCD_WHITE,16,0);
//                        break;
//                    default:
//                        sprintf(buf, "%3d", (int)ir_rx_ircode());
//                        tft_lcd_show_string(50,50,buf,TFT_LCD_RED,TFT_LCD_WHITE,16,0);
//                }
            }
        }
        
        // 显示历史最高分、当前得分
        sprintf(buf, "Best :%7d", best);
        tft_lcd_show_string(20,50,buf,TFT_LCD_BRRED,TFT_LCD_WHITE,16,1);
        sprintf(buf, "Score:%7d", score);
        tft_lcd_show_string(20,68,buf,TFT_LCD_BRRED,TFT_LCD_WHITE,16,1);
        
        // 刷新各格内数据
        for(i=0; i<4; ++i){
            for(j=0; j<4; ++j){
                sprintf(buf, "%d", (int)data2048[i][j]);
                slen = strlen(buf);
                tft_lcd_draw_rectangle(22+j*50, 94+i*50, 68+j*50, 140+i*50, TFT_LCD_LIGHTBLUE);
                tft_lcd_show_string(45+50*j-4*slen,109+50*i,buf,TFT_LCD_DARKBLUE,TFT_LCD_WHITE,16,1);
            }
        }
    }
}

// 1ms
void Timer0_interrupt(void) interrupt 1{
    static int cnt = 0;
    cnt = (cnt + 1) % tim0_ms;
    if(cnt == tim0_ms - 1){
        IO_KeyScan();
    }
}

// 0.1ms
void Timer4_interrupt(void) interrupt 20{
    ir_rec_callback();      //红外接收回调函数
    B_100us = 1;
}