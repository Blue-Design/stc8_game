C51 COMPILER V9.60.0.0   DHT11                                                             01/08/2021 01:23:27 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DHT11
OBJECT MODULE PLACED IN .\Out_File\dht11.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Device\dht11.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Device;..\Lib
                    -raries) DEBUG OBJECTEXTEND PRINT(.\dht11.lst) OBJECT(.\Out_File\dht11.obj)

line level    source

   1          #include "dht11.h"
   2          
   3          //========================================================================
   4          // 描述: 延时40us.
   5          // 参数: none.
   6          // 返回: none.
   7          //========================================================================
   8          static void delay40us()         //@24.000MHz
   9          {
  10   1              unsigned char i, j;
  11   1      
  12   1              _nop_();
  13   1              i = 2;
  14   1              j = 60;
  15   1              do
  16   1              {
  17   2                      while (--j);
  18   2              } while (--i);
  19   1      }
  20          
  21          //========================================================================
  22          // 描述: DHT11复位.
  23          // 参数: none.
  24          // 返回: none.
  25          //========================================================================
  26          void dht11_rst()
  27          {
  28   1          DHT11_DQ = 0;                  // 主机发送开始工作信号
  29   1          delay(20);                     //延时18ms以上
  30   1          DHT11_DQ = 1; 
  31   1          delay40us();
  32   1      }
  33          
  34          //========================================================================
  35          // 描述: 等待DHT11的回应.
  36          // 参数: none.
  37          // 返回: 超时返回1，否则返回0.
  38          //========================================================================
  39          uint8 dht11_check()        
  40          {   
  41   1              uint8 retry=0;
  42   1          while (DHT11_DQ&&retry<100)//DHT11会拉低40~80us
  43   1              {
  44   2                      retry++;
  45   2                      delay1us();     
  46   2              };       
  47   1              if(retry>=100)return 1;
  48   1              else retry=0;
  49   1          while (!DHT11_DQ&&retry<100)//DHT11拉低后会再次拉高40~80us
  50   1              {
  51   2                      retry++;
  52   2                      delay1us();
  53   2              };
  54   1              if(retry>=100)return 1;     
C51 COMPILER V9.60.0.0   DHT11                                                             01/08/2021 01:23:27 PAGE 2   

  55   1              return 0;
  56   1      }
  57          
  58          //========================================================================
  59          // 描述: DHT11读一个位.
  60          // 参数: none.
  61          // 返回: 读到的位.
  62          //========================================================================
  63          uint8 dht11_read_bit()                   
  64          {
  65   1              uint8 retry=0;
  66   1              while(DHT11_DQ&&retry<100)//等待变为低电平
  67   1              {
  68   2                      retry++;
  69   2                      delay1us();
  70   2              }
  71   1              retry=0;
  72   1              while(!DHT11_DQ&&retry<100)//等待变高电平
  73   1              {
  74   2                      retry++;
  75   2                      delay1us();
  76   2              }
  77   1              delay40us();//等待40us
  78   1              if(DHT11_DQ)return 1;
  79   1              else return 0;             
  80   1      }
  81          
  82          //========================================================================
  83          // 描述: DHT11读一个字节.
  84          // 参数: none.
  85          // 返回: 读到的字节.
  86          //========================================================================
  87          uint8 dht11_read_byte()    
  88          {        
  89   1          uint8 i,dat;
  90   1          dat=0;
  91   1              for (i=0;i<8;i++) 
  92   1              {
  93   2                      dat<<=1; 
  94   2                  dat|=dht11_read_bit();
  95   2          }                                               
  96   1          return dat;
  97   1      }
  98          
  99          //========================================================================
 100          // 描述: DHT11读4字节数据.
 101          // 参数: dat:读回的4字节数据数据指针.
 102          // 返回: 成功返回0，失败返回1.
 103          //========================================================================
 104          uint8 dht11_read_data(uint8 *dat)      
 105          {
 106   1              uint8 buf[5];
 107   1              uint8 i;
 108   1              dht11_rst();
 109   1              
 110   1              if(dht11_check()==0)
 111   1              {
 112   2                      for(i=0;i<5;i++)//读取40位数据
 113   2                      {
 114   3                              buf[i]=dht11_read_byte();
 115   3                      }
 116   2                      if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
C51 COMPILER V9.60.0.0   DHT11                                                             01/08/2021 01:23:27 PAGE 3   

 117   2                      {
 118   3                              *dat = buf[0];
 119   3                              *(dat+1) = buf[1];
 120   3                              *(dat+2) = buf[2];
 121   3                              *(dat+3) = buf[3];
 122   3                      }
 123   2              }else return 1;
 124   1              return 0;       
 125   1      }
 126          
 127          //========================================================================
 128          // 描述: DHT11初始化.
 129          // 参数: none.
 130          // 返回: 识别到DHT11返回0，否则返回1.
 131          //========================================================================
 132          uint8 dht11_init()
 133          {
 134   1          DHT11_DQ_MODE;
 135   1          DHT11_DQ = 1;    
 136   1          dht11_rst();
 137   1          return dht11_check();
 138   1      }
 139          
 140          //========================================================================
 141          // 描述: DHT11读湿度.
 142          // 参数: none.
 143          // 返回: 湿度值
 144          //========================================================================
 145          uint8 dht11_read_humidity()
 146          {
 147   1              uint8 mdata[4];
 148   1              uint8 err;
 149   1              do
 150   1              {
 151   2                      err = dht11_read_data(mdata);
 152   2              } while (err);
 153   1              
 154   1              return mdata[0];
 155   1      
 156   1      }
 157          
 158          //========================================================================
 159          // 描述: DHT11读温度.
 160          // 参数: none.
 161          // 返回: 温度值
 162          //========================================================================
 163          float dht11_read_temp()
 164          {
 165   1              uint8 mdata[4];
 166   1              uint8 err;
 167   1              float f;
 168   1              do
 169   1              {
 170   2                      err = dht11_read_data(mdata);
 171   2              } while (err);
 172   1              
 173   1              f = mdata[2] & 0x7F;
 174   1          f *= 10;
 175   1          f += mdata[3];
 176   1          f /= 10;
 177   1          if (mdata[2] & 0x80)
 178   1              f *= -1;
C51 COMPILER V9.60.0.0   DHT11                                                             01/08/2021 01:23:27 PAGE 4   

 179   1              return f;
 180   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    641    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      25
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
